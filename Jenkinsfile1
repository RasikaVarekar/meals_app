pipeline {
    agent any

    environment {
        FLUTTER_HOME = 'C:/flutter_windows_3.24.4-stable/flutter'
        GIT_HOME = 'C:/Program Files/Git/bin'
        ANDROID_SDK_ROOT = 'C:/Users/Admin/AppData/Local/Android/Sdk'
    }

    options {
        timeout(time: 20, unit: 'MINUTES')
    }

    stages {
        stage('Checkout') {
            steps {
                script {
                    def gitRepoUrl = 'https://github.com/RasikaVarekar/meals_app.git'
                    checkout([$class: 'GitSCM', 
                        branches: [[name: '*/main']],
                        userRemoteConfigs: [[url: gitRepoUrl]],
                        extensions: [[$class: 'CleanBeforeCheckout']]
                    ])
                }
            }
        }

        stage('Check Git Version') {
            steps {
                bat '''
                    echo üîç Checking git version...
                    "C:/Program Files/Git/bin/git.exe" --version
                '''
            }
        }

        stage('Flutter Clean') {
            steps {
                bat '''
                    set PATH=C:/flutter_windows_3.24.4-stable/flutter/bin;%PATH%
                    flutter clean
                '''
            }
        }

        stage('Flutter Pub Get') {
            steps {
                bat '''
                    set PATH=C:/flutter_windows_3.24.4-stable/flutter/bin;%PATH%
                    echo ‚úÖ Running flutter pub get...
                    flutter pub get || (echo ‚ùå flutter pub get failed! && exit 1)
                '''
            }
        }

        stage('Analyze Code') {
            steps {
                bat '''
                    set PATH=C:/flutter_windows_3.24.4-stable/flutter/bin;%PATH%
                    echo ‚úÖ Analyzing code...
                    flutter analyze || (echo ‚ùå flutter analyze failed! && exit 1)
                '''
            }
        }

        stage('Run Tests') {
            steps {
                bat '''
                    set PATH=C:/flutter_windows_3.24.4-stable/flutter/bin;%PATH%
                    echo ‚úÖ Running tests...
                    flutter test || (echo ‚ùå flutter test failed! && exit 1)
                '''
            }
        }
    }

    post {
        failure {
            echo '‚ùå Flutter build pipeline failed!'
        }
        success {
            echo '‚úÖ Flutter build pipeline completed successfully!'
        }
    }
}
